<div id="question-header">
  <h1><%= link_to safe_html(@question.title), @question, :class => "question-hyperlink" %></h1>
</div>
<div class="question_detail">
  <div class="current_question_contorl">
    <% followed =  @question.followed_dy? current_user.id 
       favorited =  @question.favorite_dy? current_user.id %>
      <a class="btn <%= followed ? '' : 'success' %>" id="followed-question" href="/questions/<%= @question.id %>/follow">
        <%= followed ? "取消关注" : "关注问题"  %></a>
      <a class="btn <%= favorited ? '' : 'success' %>" id="favorited-question" href="/questions/<%= @question.id %>/favorite">
      <%= favorited ? "取消收藏" : "收藏问题"  %></a>
  </div>
  <div class="question_info">
      <h4>问题状态</h4>
      <p>关注者<span class="blueBlod"><%= @question.followed_questions_count %></span>人</p>
      <% @question.followed_users.each do |user|%>
        <a title="<%= user.name %>" href="../users/<%= user.id %>"><img src="<%= user.gavatar %>" class='user_head'/></a>
      <% end %> 
  </div>
</div>
<div id="main-content" class="span12">
  <%= div_for(@question, :class => "clearfix") do %>
  <div class="vote-area">
    <a class="vote-up-off" href="/questions/<%= @question.id %>/vote_for">up vote</a>
    <span class="vote-count-post" id="<%= @question.id %>"><%= @question.votes_count %></span>
    <a class="vote-down-off" href="/questions/<%= @question.id %>/vote_against">down vote</a>
    </div>
  </div>
  <div class="post">
    <div class="content">
      <%= @question.content.html_safe %>
    </div>
    <% if (@question.rules_list.present? and (rules = @question.rules_list[1..-2]).present?) or @question.customized_rule.present? %>
      <div class='submission-rules'>
        <div>竞赛规则</div>
        <ul>
          <% rules.split(", ").each do |item| %>
             <li><%= Settings.send("r"+item) %></li>
          <% end %>
          <% if @question.customized_rule.present? %>
             <li><%= @question.customized_rule %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <%= render "/partials/passport", :user => @question.user %>
  </div>
  <% end %>
  
  <% if @question.answered_by? current_user.id %>
    <div id="my-answer">
      <div id="my-answer-header">
        <div class="subheader">
          <h2>我的答案</h2>
        </div>
      </div>
      <%= render @question.answer_for current_user.id %>
    </div>
  <% end %>
  <div id="answers">
    <div id="answers-header">
      <div class="subheader">
        <% if @question.answers_count > 0 %>
        <h2><%= @question.answers_count %> 个答案</h2>
        <% end %>
      </div>
    </div>
    <%= render @question.answers %>
  </div>
  <%= render 'answer_form' %>
</div>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
    $(".vote-up-off, .vote-down-off").live("click", function(e){
      e.preventDefault();
      var dom = this;
      $.ajax({
        url: this.href,
        type: 'PUT',
        dataType: 'json',
        success: function(data, textStatus, xhr) {
          $("#"+data.id).html(data.votes_count);
        },
        error: function(xhr,textStatus, errorThrown) {
          var errorText = "";
          var errorRc = JSON.parse(xhr.responseText).rc
          switch(errorRc){
            case 1:errorText = "低于10分不能投正票";break;
            case 2:errorText = "您已经投过了";break;
            case 3:errorText = "低于125分不能投负票";break;
          }
          showAjaxError($(dom).closest(".vote-area"),errorText)
        }
      });
    });
  });
</script>